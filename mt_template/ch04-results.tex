\chapter{Results}

\section{A look at trajectories}
\begin{figure}
\centering \includegraphics*[width=0.9\textwidth]{figures/0627_sued}
\caption{Color according to: Trajectory index(top left), temperature(top right), pressure(bottom left), relative humidity(bottom right)}
\label{fig:2by2_sued}
\end{figure}
\begin{figure}
\centering \includegraphics*[width=0.9\textwidth]{figures/0627_chur}
\caption{Colors according to same criteria as in figure \ref{fig:2by2_sued} above. The colors in the upper left case also depend on the trajectory set: Purple/blue forward, orange/black backward}
\label{fig:2by2_chur}
\end{figure}

%TODO maybe include a case of comparing timesteps?
% and how about an image of "Hey,like lagranto"

Figures \ref{fig:2by2_sued} and \ref{fig:2by2_chur} show examples of trajectories we computed and visualized. In the top left part, each trajectory has a constant color which depends on its index: Starting at blue for the first trajectory and ending at purple. Figure \ref{fig:2by2_chur} includes another color scheme (black-orange) for the trajectories that were computed with a negative timestep. The upper right part of is colored according to temperature: Blue is cold, white is $0^{\circ}$C, red is warm. The lower two sections visualize pressure (red at high values, bright at low ones) and relative humidity (yellow at $0 \%$ and blue at $100 \%$).

Figure \ref{fig:2by2_sued} shows a set of trajectories starting on the south side of the alps. The particles start at $13:00$ of the second day ($22. $Nov$ 2016$) at a latitude of $45.2 ^{\circ} N$ and are traced for $5$ hours as they move north. The initial points are spread across $7.5 - 10.5 ^{\circ} E$ in $lon$-direction and $2500 - 3000 m$ in height. The three variables temperature, pressure and humidity appear to be strongly correlated: The colors have similar patterns, starting cold/high/humid and becoming significantly warmer/lower/drier after passing the mountains.

Figure \ref{fig:2by2_chur} shows several trajectories passing over Chur (around $9.53 ^{\circ}E$ $46.85^{\circ} N$). The starting time for the simulation is midnight between the $22.$ and $23.$ November. The integration time is $3$ hours in both directions (so from $21:00$ to $3:00$). Temperature and pressure behave as expected, becoming lower at higher altitudes. The relative humidity seems to have two wet and dry regions each.

\begin{figure}
\centering \includegraphics*[width=0.9\textwidth]{figures/0627_zooming}
\caption{A closer look of the top left part of figure \ref{fig:2by2_sued}}
\label{fig:zooming}
\end{figure}
Figure \ref{fig:zooming} shows a zoomed-in view where one can see how trajectories make wave shapes over the mountains. In the right part one can also see a few cases where a trajectory suddenly jumps up (TODO actually not very visible, so ... good?). These jumps happen when the trajectory goes trough the ground. LAGRANTO has a similar behaviour and in both cases it can be disabled with an optional flag (in which case trajectories that leave the domain end there).

\begin{figure}
\centering \includegraphics*[width=0.9\textwidth]{figures/0627_highanddry}
\caption{Relative humidity is high below and low above}
\label{fig:highanddry}
\end{figure}
Figure \ref{fig:highanddry} shows that the air high above ($14 - 16 km$) has low relative humidity, especially compared to the lower trajectories (which start around height $4 km$). This is also forward and backward, third day, $3:00$ to $9:00$. Also visible: The wind speeds are higher above and so the upper trajectories cover more area than the lower ones.

%what can be seen in the pictures: trajectories passing through one location, color according to variables ... and the point is?

%Maybe an example of high and low winds going in slightly different directions (or was that the time difference?)

%definitely show how trajectories have wave shapes across mountains

%if possible: wind going along a valley

%maybe weird results like mid-air jumps


\section{Quality comparison}

\begin{figure}
\centering \includegraphics*[width=0.9\textwidth]{figures/plot_dt1}
\label{fig:plot_dt1}
\centering \includegraphics*[width=0.9\textwidth]{figures/plot_dt2}
\label{fig:plot_dt2}
\centering \includegraphics*[width=0.9\textwidth]{figures/plot_dt5}
\caption{Average distance between LAGRANTO trajectories and ours, timestep is $h = 1 min$ on top, $h = 2 min$ in the middle, $h = 5 min$ on the bottom}
\label{fig:plot_dt5}
\end{figure}

The plots in figure \ref{fig:plot_dt5} plot the difference between trajectories computed by LAGRANTO and five variants of our tracing algorithm. All values are averaged over around $7000$ trajectories. The five variants are:
\begin{itemize}
\item Copying LAGRANTO: Settings to perform almost exactly the same operations as LAGRANTO
\item Sample W correctly: Examining the LAGRANTO code showed that the vertical velocity $W$ was being sampled on a staggered grid even after it had been destaggered. This is an error.
\item Level interpolation on 4 columns: Use the procedure described in section \ref{sec:zsampling_mine} .
\item Runge-Kutta instead of Iterative Euler: Changes the ODE solver.
\item All improvements: Combines the three variants above.
\end{itemize}
%TODO visualize trajectories as well?

All trajectories start and end within the boundaries of the domain. Frequent collisions with the ground would distort the results significantly and have been avoided by the choice of starting positions (the starting heights are at least $7 km$) and by not tracing particles for too long.

What can be seen is that the black line (representing the LAGRANTO-like setting) stays at a very low value. There are small variations, but we can reproduce the LAGRANTO results almost exactly.

The right side which measures the average vertical distance looks very chaotic and is not very useful for gathering information. The reason for this is unclear. It is possibly related to how trajectories have wave shapes when passing over mountains.

The choice of integrator does not matter that much for small timesteps, but in the case of $h=5min$ the Runge-Kutta curve dominates the left plot. When viewing the actual trajectories, the Runge-Kutta trajectories are usually better at following the shape of the landscape.%TODO picture for that?

It appears that how to sample across $level$s makes more of a difference than correcting the sampling of $W$. The fact that both of those affect the $z$ axis may be another factor in the irregular curves on the right side.

\section{Performance}

There are two main performance bottlenecks: Reading the data and doing computations on each particle and timestep. We added a simple OpenMP parallelization for iterating over all trajectories during the simulation phase and hope to at least match the speed of LAGRANTO with that.

\begin{figure}
\centering \includegraphics*[width=0.9\textwidth]{figures/plot_times}
\caption{Times for tracing a variable number of particles over $60$ timesteps and $7$ data files}
\label{fig:plot_time}
\end{figure}

Figure \ref{fig:plot_time} plots the measured times for a test case of computing different numbers of trajectories. As expected, the time scales linearly in the number of trajectories. Our method is faster than LAGRANTO in all cases. In the early part, where the reading of the data makes up almost all of the time, our version does in roughly $1.5$ minutes what LAGRANTO does in $4$. Increasing the number of trajectories, it becomes evident that our version also has a better scaling, even when unparallelized.

%TODO test against length of simulation.

All time measurements were taken on the same machine: It has an Intel\textsuperscript{\textregistered} Core\textsuperscript{\texttrademark} i5-3427U CPU with $4$ cores running at $1.80$ GHz with $7.7$ GiB of memory.

%First experiment: $4$ trajectories, $7$ input files, $60$ iterations. Most of the work is reading the files.
%Second experiment: $459045$ trajectories, $7$ input files and $60$ iterations again. This involves more computations.
